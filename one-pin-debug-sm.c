/**
* \version 1.0
* \author bazhen.levkovets
* \date 2019 
*************************************************************************************
* \copyright	Bazhen Levkovets
* \copyright	Brovary
* \copyright	Ukraine
*************************************************************************************
*/

/*
**************************************************************************
*							INCLUDE FILES
**************************************************************************
*/
	#include	"one-pin-debug-sm.h"
	#include	"main.h"
/*
**************************************************************************
*							LOCAL DEFINES
**************************************************************************
*/
	#define BITS_IN_BYTE_QTY	8
	//#define	LOG_UART_BIT_DELAY	53	//	38`400
	#define	LOG_UART_BIT_DELAY	78	//	62`500 at 72MHz from 60`000 to 65`000 -> 16 uSec
	#define CHECK_BIT(var, pos) (((var) & (1UL << (pos))) != 0)
/*
**************************************************************************
*							LOCAL CONSTANTS
**************************************************************************
*/
	OnePin_Debug_struct 		hOnePin ;
/*
**************************************************************************
*						    LOCAL DATA TYPES
**************************************************************************
*/


/*
**************************************************************************
*							  LOCAL TABLES
**************************************************************************
*/

/*
**************************************************************************
*								 MACRO'S
**************************************************************************
*/


/*
**************************************************************************
*						 LOCAL GLOBAL VARIABLES
**************************************************************************
*/

/*
**************************************************************************
*                        LOCAL FUNCTION PROTOTYPES
**************************************************************************
*/
	void Send_byte(	uint8_t		_byte			) ;
	void Send_bit(	uint8_t		_bit			) ;
	void Delay_us(	uint32_t	_delay_time_u32	) ;
/*
**************************************************************************
*                           GLOBAL FUNCTIONS
**************************************************************************
*/
void One_Pin_Init(	GPIO_TypeDef*			_port				,
					uint16_t				_pin				,
					uint8_t					_status				) {
	hOnePin.status_u8 	= _status	;
	hOnePin.Port		= _port		;
	hOnePin.Pin			= _pin		;
} //***************************************************************

void One_Pin_Debug_Print(	uint8_t*	_debug_buffer	,
							uint8_t 	_debug_size_u8	) {
	for ( int i =0; i <_debug_size_u8;  i++ ) {
		Send_byte( _debug_buffer[i] ) ;
	}
} //***************************************************************
  //***************************************************************

/*
**************************************************************************
*                           LOCAL FUNCTIONS
**************************************************************************
*/

void Send_byte(	uint8_t	_byte ) {
	Send_bit( 0 );
	for ( uint8_t i = 0; i < BITS_IN_BYTE_QTY; i++) {
		Send_bit( CHECK_BIT(_byte, i));
	}
	Send_bit( 1 );
} //***************************************************************

void Send_bit( uint8_t	_bit ) {
    if( _bit ) {
    	HAL_GPIO_WritePin( hOnePin.Port , hOnePin.Pin,   SET ) ;
    } else {
    	HAL_GPIO_WritePin( hOnePin.Port , hOnePin.Pin, RESET ) ;
    }

    Delay_us(LOG_UART_BIT_DELAY);  // 25uS -> UART speed  = 38`400
} /***************************************************************/

void Delay_us(uint32_t _delay_time_u32) {
	for (; _delay_time_u32; _delay_time_u32--) {
		__asm("nop") ;
	}
} /***************************************************************/

/*
**************************************************************************
*                           	END
**************************************************************************
*/
